name: CD - Deploy to Dev/Staging

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - main
    types: [closed]  # PR 合并时触发
  workflow_dispatch:  # 允许手动触发
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging

env:
  REGISTRY: ccr.ccs.tencentyun.com
  REGISTRY_NAMESPACE: feiyue-dev
  BACKEND_IMAGE: feiyue-backend
  FRONTEND_IMAGE: feiyue-frontend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy to Dev Environment
    if: |
      github.ref == 'refs/heads/develop' || 
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Get version info
        id: version
        run: |
          echo "sha_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Tencent Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.TENCENT_REGISTRY_USERNAME }}
          password: ${{ secrets.TENCENT_REGISTRY_PASSWORD }}
      
      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend-csharp
          file: ./backend-csharp/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.BACKEND_IMAGE }}:${{ steps.env.outputs.environment }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.BACKEND_IMAGE }}:${{ steps.env.outputs.environment }}-${{ steps.version.outputs.sha_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          build-args: |
            VITE_API_BASE_URL=${{ secrets.DEV_API_BASE_URL }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.FRONTEND_IMAGE }}:${{ steps.env.outputs.environment }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.FRONTEND_IMAGE }}:${{ steps.env.outputs.environment }}-${{ steps.version.outputs.sha_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Deploy to Dev Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /opt/feiyue
            
            # 登录镜像仓库
            echo "${{ secrets.TENCENT_REGISTRY_PASSWORD }}" | docker login \
              -u ${{ secrets.TENCENT_REGISTRY_USERNAME }} \
              --password-stdin ${{ env.REGISTRY }}
            
            # 拉取最新镜像
            docker pull ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.BACKEND_IMAGE }}:${{ steps.env.outputs.environment }}
            docker pull ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.FRONTEND_IMAGE }}:${{ steps.env.outputs.environment }}
            
            # 重启服务
            docker-compose -f docker-compose.dev.yml down
            docker-compose -f docker-compose.dev.yml up -d
            
            # 清理旧镜像
            docker image prune -af --filter "until=24h"
            
            # 健康检查
            sleep 5
            curl -f http://localhost:8000/health || exit 1
            
            echo "✅ Dev deployment completed!"
