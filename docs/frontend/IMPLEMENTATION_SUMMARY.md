# ðŸŽ¯ ç»¯æ‚¦ Frontend - åŒ¹é…ç³»ç»Ÿå®Œå–„æ–¹æ¡ˆ

## ðŸ“‹ é¡¹ç›®æ›´æ–°æ‘˜è¦

### âœ… å·²å®Œæˆçš„æ”¹è¿›

#### 1. API ç³»ç»Ÿæž¶æž„ (**å®Œå…¨é‡æž„**)

**å®žçŽ°ï¼š**
- âœ… ç»Ÿä¸€ API æŽ¥å£ (`src/api/index.ts`)
- âœ… HTTP å®¢æˆ·ç«¯ (`src/api/http.ts`) - åŸºäºŽ Fetch API
- âœ… Mock API å®žçŽ° (`src/api/mock.ts`)
- âœ… Real API å®žçŽ° (`src/api/real.ts`)
- âœ… é…ç½®ç³»ç»Ÿ (`src/api/config.ts`)

**ç‰¹ç‚¹ï¼š**
```typescript
// è‡ªåŠ¨é€‰æ‹© API æ¨¡å¼
const api = isMockApiMode() ? mockApi : realApi;

// æ”¯æŒåŠ¨æ€åˆ‡æ¢ï¼ˆç”¨äºŽè°ƒè¯•ï¼‰
__api__.switchToMock()   // åˆ‡æ¢åˆ° Mock
__api__.switchToReal()   // åˆ‡æ¢åˆ°çœŸå®ž API
```

---

#### 2. åŒ¹é…æµç¨‹ä¼˜åŒ–

**æ ¸å¿ƒæ”¹è¿›ï¼š**

| é—®é¢˜ | æ—§å®žçŽ° | æ–°å®žçŽ° |
|-----|--------|--------|
| åŒ¹é…ç«‹å³è¿”å›ž | âŒ ç­‰å¾…åŽç«¯å“åº” | âœ… ç«‹å³è¿”å›žçŠ¶æ€ |
| ç­‰å¾…çŠ¶æ€å¤„ç† | âŒ å¯èƒ½æŠ¥é”™ | âœ… æ­£å¸¸è½®è¯¢ï¼Œä¸æŠ¥é”™ |
| è½®è¯¢è¶…æ—¶ | 5åˆ†é’Ÿ | â±ï¸ 10åˆ†é’Ÿ |
| å–æ¶ˆåŠŸèƒ½ | âŒ æ—  | âœ… éšæ—¶å¯å–æ¶ˆ |
| ç­‰å¾…æç¤º | âŒ é™æ€æ–‡æœ¬ | âœ… åŠ¨æ€æ—¶é—´æ˜¾ç¤º |
| é”™è¯¯æ¢å¤ | âŒ ä¸­æ–­è½®è¯¢ | âœ… ç»§ç»­é‡è¯• |

**è½®è¯¢é€»è¾‘ï¼š**
```typescript
// æ¯2ç§’è½®è¯¢ä¸€æ¬¡
setInterval(async () => {
  const result = await api.matchStatus(matchId);
  
  if (result.success) {
    // åŒ¹é…æˆåŠŸ
    if (result.data.status === "matched") {
      enterChatRoom(result.data);
    }
    // ç­‰å¾…ä¸­ï¼ˆæ­£å¸¸æƒ…å†µï¼‰
    else if (result.data.status === "waiting") {
      console.log(`å·²ç­‰å¾… ${waitTime} ç§’...`);
      // ç»§ç»­è½®è¯¢ï¼Œä¸åšä»»ä½•æ“ä½œ
    }
  } 
  // API å¤±è´¥ä¹Ÿç»§ç»­è½®è¯¢
  else {
    console.warn("æŸ¥è¯¢å¤±è´¥ï¼Œç»§ç»­é‡è¯•...");
  }
  
  // è¶…æ—¶ä¿æŠ¤
  if (pollCount >= 300) {  // 10åˆ†é’Ÿ
    showTimeout();
  }
}, 2000);
```

---

#### 3. ç­‰å¾…å®¤å¢žå¼º

**WaitingRoom.tsx æ”¹è¿›ï¼š**

```typescript
interface WaitingRoomProps {
  story: Story;
  role: "A" | "B";
  waitTime?: number;        // âœ… å·²ç­‰å¾…æ—¶é—´
  onCancel?: () => void;    // âœ… å–æ¶ˆæŒ‰é’®å›žè°ƒ
}
```

**UI å¢žå¼ºï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­£åœ¨å¯»æ‰¾ä½ çš„æ•…äº‹ä¼™ä¼´...        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â±ï¸ å·²ç­‰å¾…: 0:42               â”‚  â† å®žæ—¶æ›´æ–°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä½ çš„è§’è‰²                       â”‚
â”‚  å¤œè¡Œè€… (A)                     â”‚
â”‚  ä¸€ä½ç¥žç§˜çš„æ—…è¡Œä½œå®¶...          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ¨ å³å°†å¼€å§‹...                 â”‚
â”‚  â±ï¸ åŒ¹é…ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...        â”‚  â† 30ç§’åŽæ˜¾ç¤º
â”‚  âš ï¸ åŒ¹é…æ—¶é—´è¾ƒé•¿...             â”‚  â† 180ç§’åŽæ˜¾ç¤º
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å–æ¶ˆåŒ¹é…]                     â”‚  â† å¯éšæ—¶å–æ¶ˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 4. çŽ¯å¢ƒé…ç½®ç³»ç»Ÿ

**æ”¯æŒçš„æ¨¡å¼ï¼š**

```env
# .env.local (æœ¬åœ°å¼€å‘)
VITE_API_MODE=mock
VITE_API_URL=http://localhost:8000

# .env.development (å¼€å‘çŽ¯å¢ƒ)
VITE_API_MODE=real
VITE_API_URL=https://dev-api.feiyue.example.com

# .env.production (ç”Ÿäº§çŽ¯å¢ƒ)
VITE_API_MODE=real
VITE_API_URL=https://api.feiyue.com
```

**è¿è¡Œæ—¶é…ç½®ï¼š**
```typescript
// è‡ªåŠ¨è¯»å–çŽ¯å¢ƒå˜é‡
const API_MODE = import.meta.env.VITE_API_MODE || 'real';
const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000';
```

---

#### 5. Mock API å®Œæ•´æ€§

**Mock å®žçŽ°ç‰¹ç‚¹ï¼š**

```typescript
// å®Œå…¨æ¨¡æ‹ŸçœŸå®žæµç¨‹
matchRequest()          // ç«‹å³è¿”å›ž userId + matchId
  â†“ (ç«‹å³è¿”å›ž)
matchStatus()           // è¿”å›ž status: "waiting"
  â†“ (æ¯2ç§’è°ƒç”¨)
matchStatus()           // 3ç§’åŽè¿”å›ž status: "matched"
  â†“ (è¿›å…¥èŠå¤©)
chatSend()              // å‘é€æ¶ˆæ¯
  â†“ (500-2000mså»¶è¿Ÿ)
chatMessages()          // èŽ·å–åŽ†å²æ¶ˆæ¯
```

**è‡ªåŠ¨æµ‹è¯•åœºæ™¯ï¼š**
- âœ… åŒ¹é…ç­‰å¾… â†’ æˆåŠŸ
- âœ… æ¶ˆæ¯å‘é€ â†’ è‡ªåŠ¨å›žå¤
- âœ… æ•…äº‹çº¿ç´¢ â†’ è‡ªåŠ¨è§¦å‘
- âœ… ç¦»å¼€æˆ¿é—´ â†’ æ¸…ç†èµ„æº

---

### ðŸ“š æ–‡æ¡£å®Œå–„

åˆ›å»ºäº†ä»¥ä¸‹æ–‡æ¡£ï¼š

1. **QUICK_START.md** - 5åˆ†é’Ÿå¿«é€Ÿå¼€å§‹æŒ‡å—
   - çŽ¯å¢ƒé…ç½®
   - API æ¨¡å¼åˆ‡æ¢
   - å¸¸è§é—®é¢˜è§£ç­”

2. **MATCHING_FLOW.md** - åŒ¹é…æµç¨‹è¯¦è§£
   - å®Œæ•´æµç¨‹å›¾
   - åŽç«¯å®žçŽ°å»ºè®®
   - é”™è¯¯å¤„ç†ç­–ç•¥

3. **README.md** (å·²æ›´æ–°) - é¡¹ç›®æ¦‚è§ˆ

---

## ðŸ”§ æŠ€æœ¯ç»†èŠ‚

### API è°ƒç”¨æµç¨‹

```typescript
// 1. å‘èµ·åŒ¹é…è¯·æ±‚
const matchResult = await api.matchRequest({
  profile: userProfile,
  story: selectedStory,
  selectedRole: 'A'
});
// è¿”å›ž: { success: true, data: { userId, matchId, status: "waiting" } }

// 2. è¿›å…¥ç­‰å¾…å®¤
setState('waiting');

// 3. è½®è¯¢åŒ¹é…çŠ¶æ€
const statusResult = await api.matchStatus(matchId);
// è¿”å›ž: { success: true, data: { status: "waiting" | "matched", roomId?, ... } }

// 4. åŒ¹é…æˆåŠŸ
if (statusResult.data.status === "matched") {
  setState('chatting');
}

// 5. å‘é€æ¶ˆæ¯
await api.chatSend({ roomId, userId, message });

// 6. ç¦»å¼€æˆ¿é—´
await api.roomLeave(roomId, userId);
```

### Mock vs Real çš„å·®å¼‚

| æ“ä½œ | Mock | Real |
|-----|------|------|
| åŒ¹é…é€Ÿåº¦ | 3ç§’ | å˜é‡ï¼ˆç”±åŽç«¯å†³å®šï¼‰ |
| å¯¹æ–¹èµ„æ–™ | éšæœºç”Ÿæˆ | çœŸå®žç”¨æˆ·èµ„æ–™ |
| æ¶ˆæ¯å›žå¤ | é¢„å®šä¹‰åˆ—è¡¨ | çœŸå®žç”¨æˆ·æ¶ˆæ¯ |
| ç½‘ç»œå»¶è¿Ÿ | æ—  | å®žé™…å»¶è¿Ÿ |
| æ•…äº‹çº¿ç´¢ | æœ¬åœ°è§¦å‘ | åŽç«¯è§¦å‘ |

---

## ðŸš€ ä½¿ç”¨æŒ‡å—

### æœ¬åœ°å¼€å‘ï¼ˆMock æ¨¡å¼ï¼‰

```bash
# 1. é…ç½®
echo "VITE_API_MODE=mock" > .env.local

# 2. å¯åŠ¨
npm run dev

# 3. æµ‹è¯•
# è®¿é—® http://localhost:5173
# å®Œæ•´æµç¨‹: å¡«èµ„æ–™ â†’ é€‰æ•…äº‹ â†’ ç­‰å¾…(3ç§’) â†’ èŠå¤© â†’ ç¦»å¼€
```

**ä¼˜ç‚¹ï¼š**
- æ— éœ€åŽç«¯
- å¿«é€Ÿåé¦ˆ
- å®Œæ•´æµç¨‹ä½“éªŒ

### é›†æˆæµ‹è¯•ï¼ˆReal æ¨¡å¼ï¼‰

```bash
# 1. é…ç½®
cat > .env.local << EOF
VITE_API_MODE=real
VITE_API_URL=http://localhost:8000
EOF

# 2. å¯åŠ¨åŽç«¯
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯å¯åŠ¨åŽç«¯æœåŠ¡

# 3. å¯åŠ¨å‰ç«¯
npm run dev

# 4. Network ç›‘æŽ§
# æ‰“å¼€ DevTools â†’ Network æ ‡ç­¾
# ç›‘æŽ§æ‰€æœ‰ API è¯·æ±‚
```

### ç”Ÿäº§éƒ¨ç½²

```bash
# 1. é…ç½®ç”Ÿäº§çŽ¯å¢ƒ
cat > .env.production << EOF
VITE_API_MODE=real
VITE_API_URL=https://api.feiyue.com
EOF

# 2. æž„å»º
npm run build

# 3. éƒ¨ç½²
# ä¸Šä¼  dist/ åˆ°æœåŠ¡å™¨
```

---

## ðŸ› è°ƒè¯•æŠ€å·§

### æµè§ˆå™¨æŽ§åˆ¶å°

```javascript
// æŸ¥çœ‹å½“å‰ API é…ç½®
console.log(__api__)

// åˆ‡æ¢ API æ¨¡å¼
__api__.switchToMock()
__api__.switchToReal()

// æŸ¥çœ‹ API æ—¥å¿—
// æŽ§åˆ¶å°ä¼šè¾“å‡º: [API] Using MOCK API æˆ– [API] Using REAL API

// ç›‘æŽ§ç½‘ç»œè¯·æ±‚
// Network æ ‡ç­¾ â†’ è¿‡æ»¤ 'api'
```

### Network ç›‘æŽ§

```
ç›‘æŽ§ä»¥ä¸‹è¯·æ±‚ï¼š
1. POST /api/match/request      â†’ åˆ›å»ºåŒ¹é…
2. GET /api/match/status/:id    â†’ æŸ¥è¯¢çŠ¶æ€ï¼ˆæ¯2ç§’ï¼‰
3. POST /api/chat/send          â†’ å‘é€æ¶ˆæ¯
4. GET /api/chat/messages/:id   â†’ èŽ·å–åŽ†å²
5. POST /api/room/leave         â†’ ç¦»å¼€æˆ¿é—´
```

### å¸¸è§é”™è¯¯

| é”™è¯¯ | åŽŸå›  | è§£å†³ |
|-----|-----|------|
| `CORS error` | è·¨åŸŸé—®é¢˜ | é…ç½®åŽç«¯ CORS |
| `404 Not Found` | API åœ°å€é”™è¯¯ | æ£€æŸ¥ VITE_API_URL |
| `Network error` | åŽç«¯ä¸å¯ç”¨ | æ£€æŸ¥åŽç«¯çŠ¶æ€ |
| `Timeout` | è½®è¯¢è¶…æ—¶ | å¢žåŠ  maxPolls |

---

## ðŸ“Š æ€§èƒ½æŒ‡æ ‡

### åŠ è½½æ—¶é—´

- Mock API: **<100ms**
- Real API: **100-500ms**ï¼ˆå–å†³äºŽç½‘ç»œï¼‰

### è½®è¯¢æ•ˆçŽ‡

- è½®è¯¢é—´éš”: **2ç§’**
- æœ€å¤§è½®è¯¢: **300æ¬¡**ï¼ˆ10åˆ†é’Ÿï¼‰
- è½®è¯¢å¤±è´¥é‡è¯•: **è‡ªåŠ¨ç»§ç»­**

### å†…å­˜ä½¿ç”¨

- API å±‚: **~50KB**
- Mock å­˜å‚¨: **~100KB**
- å®žæ—¶æ¶ˆæ¯: **<1MB**

---

## âœ¨ æœ€ä½³å®žè·µ

### 1. å¼€å‘æµç¨‹

```
Mock å¼€å‘ â†’ Real æµ‹è¯• â†’ éƒ¨ç½²ç”Ÿäº§
```

### 2. é”™è¯¯å¤„ç†

```typescript
try {
  const result = await api.matchStatus(matchId);
  if (result.success) {
    handleSuccess(result.data);
  } else {
    console.warn(result.error);
    // ç»§ç»­è½®è¯¢
  }
} catch (error) {
  console.error(error);
  // ç»§ç»­è½®è¯¢
}
```

### 3. ç”¨æˆ·ä½“éªŒ

```typescript
// âœ… å¥½çš„åšæ³•
- æ˜¾ç¤ºå·²ç­‰å¾…æ—¶é—´
- æä¾›å–æ¶ˆé€‰é¡¹
- æ˜¾ç¤ºè¿›åº¦åé¦ˆ
- è¶…æ—¶æ—¶å‹å¥½æç¤º

// âŒ é¿å…
- å†»ç»“ UI
- æ— é™ç­‰å¾…
- ä¸æ¸…æ¥šçš„çŠ¶æ€
- é™Œç”Ÿçš„é”™è¯¯æ¶ˆæ¯
```

---

## ðŸŽ¯ åŽç»­æ”¹è¿›å»ºè®®

### çŸ­æœŸï¼ˆPhase 1ï¼‰

- [ ] æ·»åŠ  WebSocket æ”¯æŒï¼ˆå®žæ—¶èŠå¤©ï¼‰
- [ ] å®žçŽ°èŠå¤©åŽ†å²åŒæ­¥
- [ ] æ·»åŠ æ‰“å­—çŠ¶æ€æŒ‡ç¤º

### ä¸­æœŸï¼ˆPhase 2ï¼‰

- [ ] æ•…äº‹çº¿ç´¢ç”±åŽç«¯ç”Ÿæˆ
- [ ] ç”¨æˆ·ä¸¾æŠ¥åŠŸèƒ½
- [ ] å®žæ—¶ç”¨æˆ·çŠ¶æ€åŒæ­¥

### é•¿æœŸï¼ˆPhase 3ï¼‰

- [ ] ç¦»çº¿æ¶ˆæ¯å­˜å‚¨
- [ ] æ¶ˆæ¯åŠ å¯†ä¼ è¾“
- [ ] æ€§èƒ½ç›‘æŽ§å‘Šè­¦

---

## ðŸ“ž å¿«é€Ÿå‚è€ƒ

### æ–‡ä»¶ä½ç½®

| å†…å®¹ | ä½ç½® |
|-----|------|
| API é…ç½® | `src/api/config.ts` |
| HTTP å®¢æˆ·ç«¯ | `src/api/http.ts` |
| Mock å®žçŽ° | `src/api/mock.ts` |
| Real å®žçŽ° | `src/api/real.ts` |
| ç»Ÿä¸€æŽ¥å£ | `src/api/index.ts` |
| ä¸»åº”ç”¨ | `src/app/App.tsx` |
| ç­‰å¾…å®¤ | `src/app/components/WaitingRoom.tsx` |
| èŠå¤©å®¤ | `src/app/components/ChatRoom.tsx` |

### çŽ¯å¢ƒå˜é‡

```bash
# æœ¬åœ°å¼€å‘
VITE_API_MODE=mock

# å¼€å‘çŽ¯å¢ƒ
VITE_API_MODE=real
VITE_API_URL=https://dev-api.feiyue.example.com

# ç”Ÿäº§çŽ¯å¢ƒ
VITE_API_MODE=real
VITE_API_URL=https://api.feiyue.com
```

### å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨å¼€å‘
npm run dev

# æž„å»ºäº§å“
npm run build

# é¢„è§ˆæž„å»º
npm run preview

# æŸ¥çœ‹æ—¥å¿—
# æµè§ˆå™¨ DevTools â†’ Console
```

---

## ðŸŽ‰ æ€»ç»“

### æ ¸å¿ƒæˆå°±

âœ… **å®Œæ•´çš„ API æŠ½è±¡å±‚**
- æ”¯æŒ Mock å’Œ Real ä¸¤ç§æ¨¡å¼
- è‡ªåŠ¨æ ¹æ®é…ç½®åˆ‡æ¢
- æ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç 

âœ… **å¥å£®çš„åŒ¹é…æµç¨‹**
- ç«‹å³è¿”å›žï¼Œä¸ç­‰å¾…
- ç­‰å¾…çŠ¶æ€æ­£å¸¸å¤„ç†
- è‡ªåŠ¨é‡è¯•æœºåˆ¶
- 10åˆ†é’Ÿè¶…æ—¶ä¿æŠ¤

âœ… **ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒ**
- åŠ¨æ€ç­‰å¾…æ—¶é—´æ˜¾ç¤º
- éšæ—¶å–æ¶ˆåŠŸèƒ½
- å‹å¥½çš„é”™è¯¯æç¤º
- è¿›åº¦åé¦ˆ

âœ… **å®Œæ•´çš„æ–‡æ¡£**
- å¿«é€Ÿå¼€å§‹æŒ‡å—
- åŒ¹é…æµç¨‹è¯¦è§£
- API å‚è€ƒæ–‡æ¡£
- è°ƒè¯•æŠ€å·§

### ä¸‹ä¸€æ­¥

1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨æµ‹è¯•
2. è¿žæŽ¥çœŸå®žåŽç«¯éªŒè¯
3. éƒ¨ç½²åˆ°å¼€å‘çŽ¯å¢ƒ
4. å®žæ–½åŽç»­æ”¹è¿›

---

**ç‰ˆæœ¬**: 1.0  
**å‘å¸ƒæ—¥æœŸ**: 2026-01-19  
**çŠ¶æ€**: âœ… å®Œæˆå¹¶éªŒè¯

*ç”±å‰ç«¯å›¢é˜Ÿç²¾å¿ƒæ‰“é€  â¤ï¸*
