# ç»¯æ‚¦ - åŒ¹é…æµç¨‹è¯´æ˜

## ç³»ç»Ÿæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·å¡«å†™èµ„æ–™       â”‚
â”‚   é€‰æ‹©æ•…äº‹          â”‚
â”‚   ç³»ç»Ÿè‡ªåŠ¨åˆ†é…è§’è‰²  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å‘èµ·åŒ¹é…è¯·æ±‚        â”‚
    â”‚  POST /api/match/request
    â”‚  âœ… è¿”å› userId     â”‚
    â”‚  âœ… è¿”å› matchId    â”‚
    â”‚  âœ… è¿”å› status     â”‚
    â”‚     status="waiting"â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  è¿›å…¥ç­‰å¾…å®¤ (WaitingRoom)        â”‚
    â”‚  â±ï¸ æ˜¾ç¤ºå·²ç­‰å¾…æ—¶é—´                â”‚
    â”‚  ğŸ”„ ç”¨æˆ·å¯å–æ¶ˆåŒ¹é…                â”‚
    â”‚  ğŸ“Š æ˜¾ç¤ºåˆ†é…è§’è‰²ä¿¡æ¯              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”œâ”€â–º è½®è¯¢æŸ¥è¯¢çŠ¶æ€ (2ç§’é—´éš”)
                   â”‚   GET /api/match/status/:matchId
                   â”‚
                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚                         â”‚                        â”‚
        status="waiting"        status="matched"              (è¶…æ—¶)
        ç»§ç»­è½®è¯¢                è¿›å…¥èŠå¤©                   è¿”å›æ•…äº‹é€‰æ‹©
                   â”‚                         â”‚                        â”‚
                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                   â”‚                         â”‚                        â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚                       â”‚
                                  â–¼                       â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   è¿›å…¥èŠå¤©å®¤      â”‚   â”‚  è¿”å›é‡é€‰    â”‚
                          â”‚  (ChatRoom)       â”‚   â”‚  æ•…äº‹å¹¶é‡è¯•  â”‚
                          â”‚                   â”‚   â”‚              â”‚
                          â”‚ â€¢ å‘é€æ¶ˆæ¯        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ â€¢ æ¥æ”¶æ¶ˆæ¯        â”‚
                          â”‚ â€¢ æ•…äº‹çº¿ç´¢è§¦å‘    â”‚
                          â”‚ â€¢ ç¦»å¼€æˆ¿é—´        â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…³é”®ç‚¹è¯´æ˜

### 1. åŒ¹é…è¯·æ±‚é˜¶æ®µ

**å‰ç«¯å‘é€ï¼š**
```typescript
POST /api/match/request
{
  profile: UserProfile,      // ç”¨æˆ·èµ„æ–™
  story: Story,              // é€‰æ‹©çš„æ•…äº‹
  selectedRole: "A" | "B"    // ç³»ç»Ÿè‡ªåŠ¨åˆ†é…çš„è§’è‰²
}
```

**åç«¯è¿”å›ï¼ˆç«‹å³è¿”å›ï¼‰ï¼š**
```typescript
{
  success: true,
  data: {
    userId: "anon_abc123",     // åŒ¿åç”¨æˆ·ID
    matchId: "match_xyz789",   // åŒ¹é…IDï¼ˆç”¨äºåç»­è½®è¯¢ï¼‰
    status: "waiting"          // ç­‰å¾…çŠ¶æ€
  }
}
```

**âŒ åç«¯ä¸ä¼šç«‹å³è¿”å›é”™è¯¯ï¼Œå³ä½¿é˜Ÿåˆ—ä¸­æ²¡æœ‰å…¶ä»–ç”¨æˆ·ä¹Ÿæ˜¯å¦‚æ­¤ã€‚**

### 2. ç­‰å¾…å®¤é˜¶æ®µ

ç”¨æˆ·è¿›å…¥ç­‰å¾…å®¤ï¼ŒUIä¼šæ˜¾ç¤ºï¼š
- â±ï¸ **å·²ç­‰å¾…æ—¶é—´**ï¼šå®æ—¶æ›´æ–°
- ğŸ“ **è§’è‰²ä¿¡æ¯**ï¼šæ˜¾ç¤ºç”¨æˆ·è¢«åˆ†é…çš„è§’è‰²
- ğŸ”„ **å–æ¶ˆåŒ¹é…**ï¼šç”¨æˆ·å¯éšæ—¶å–æ¶ˆï¼Œè¿”å›æ•…äº‹é€‰æ‹©é¡µé¢

**å‰ç«¯è¡Œä¸ºï¼š**
```typescript
// æ¯2ç§’è½®è¯¢ä¸€æ¬¡åŒ¹é…çŠ¶æ€
setInterval(async () => {
  const result = await api.matchStatus(matchId);
  
  // å¦‚æœè¿”å› status="matched"ï¼Œè¿›å…¥èŠå¤©å®¤
  // å¦‚æœè¿”å› status="waiting"ï¼Œç»§ç»­è½®è¯¢ï¼ˆè¿™æ˜¯æ­£å¸¸æƒ…å†µï¼‰
  // å¦‚æœè¶…è¿‡10åˆ†é’Ÿï¼Œæç¤ºè¶…æ—¶
}, 2000);
```

### 3. åŒ¹é…æˆåŠŸçš„è¿”å›

å½“åç«¯æ‰¾åˆ°åˆé€‚çš„é…å¯¹åï¼Œè¿”å›ï¼š
```typescript
{
  success: true,
  data: {
    status: "matched",
    roomId: "room_123456",
    story: {...},
    yourRole: "B",
    partnerRole: "A"
  }
}
```

æ­¤æ—¶å‰ç«¯ï¼š
1. æ¸…ç†è½®è¯¢å®šæ—¶å™¨
2. ç”Ÿæˆæ¨¡æ‹Ÿå¯¹æ–¹èµ„æ–™ï¼ˆæˆ–ä»åç«¯è·å–ï¼‰
3. è¿›å…¥èŠå¤©å®¤

### 4. è¶…æ—¶å¤„ç†

```typescript
// 10åˆ†é’Ÿï¼ˆ300æ¬¡è½®è¯¢ï¼‰å
if (pollCount >= 300) {
  clearInterval(pollInterval);
  alert("åŒ¹é…è¶…æ—¶ï¼ˆå·²ç­‰å¾…10åˆ†é’Ÿï¼‰ï¼Œè¯·é‡è¯•");
  setState("generate");  // è¿”å›æ•…äº‹é€‰æ‹©
}
```

## åç«¯é˜Ÿåˆ—é€»è¾‘å»ºè®®

### ç­‰å¾…é˜Ÿåˆ—çš„å®ç°

```python
# åç«¯ä¼ªä»£ç 
@app.post("/api/match/request")
async def request_match(req: MatchRequest):
    # ç”Ÿæˆç”¨æˆ·IDå’ŒåŒ¹é…ID
    user_id = generate_user_id()
    match_id = generate_match_id()
    
    # å°†è¯·æ±‚åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
    queue.add({
        "user_id": user_id,
        "match_id": match_id,
        "profile": req.profile,
        "story": req.story,
        "role": req.selected_role,
        "timestamp": now()
    })
    
    # ç«‹å³è¿”å›ï¼Œä¸è¦ç­‰å¾…
    return {
        "success": True,
        "data": {
            "user_id": user_id,
            "match_id": match_id,
            "status": "waiting"
        }
    }

@app.get("/api/match/status/{match_id}")
async def get_match_status(match_id: str):
    match_request = queue.find(match_id)
    
    if match_request is None:
        return error("Match request not found")
    
    # æ£€æŸ¥æ˜¯å¦å·²é…å¯¹
    if match_request["status"] == "matched":
        return {
            "success": True,
            "data": {
                "status": "matched",
                "room_id": match_request["room_id"],
                "story": match_request["story"],
                "your_role": match_request["role"],
                "partner_role": "B" if match_request["role"] == "A" else "A"
            }
        }
    
    # å¦‚æœè¿˜æœªé…å¯¹ï¼Œè¿”å›ç­‰å¾…çŠ¶æ€
    # ç»§ç»­æ£€æŸ¥æ˜¯å¦æœ‰åˆé€‚çš„é…å¯¹å¯¹è±¡
    potential_match = find_match(match_request)
    
    if potential_match:
        # åˆ›å»ºèŠå¤©å®¤å¹¶æ ‡è®°ä¸ºå·²é…å¯¹
        room_id = create_chat_room(match_request, potential_match)
        update_match_status(match_id, "matched", room_id)
        update_match_status(potential_match["match_id"], "matched", room_id)
        
        return {
            "success": True,
            "data": {
                "status": "matched",
                "room_id": room_id,
                ...
            }
        }
    else:
        # æ²¡æœ‰æ‰¾åˆ°é…å¯¹ï¼Œè¿”å›ç­‰å¾…çŠ¶æ€
        return {
            "success": True,
            "data": {
                "status": "waiting",
                "wait_time": (now() - match_request["timestamp"]).seconds
            }
        }

def find_match(user_request):
    """ä»é˜Ÿåˆ—ä¸­æŸ¥æ‰¾åˆé€‚çš„é…å¯¹å¯¹è±¡"""
    candidates = [
        req for req in queue.get_waiting()
        if should_match(user_request, req)
    ]
    
    if candidates:
        # é€‰æ‹©æœ€åˆé€‚çš„
        return select_best_match(candidates)
    
    return None

def should_match(user1, user2):
    """åˆ¤æ–­ä¸¤ä¸ªç”¨æˆ·æ˜¯å¦å¯ä»¥é…å¯¹"""
    # ç›¸åŒæ•…äº‹
    if user1["story"]["title"] != user2["story"]["title"]:
        return False
    
    # è§’è‰²äº’è¡¥
    if user1["role"] == user2["role"]:
        return False
    
    # å¯ä»¥æ·»åŠ æ›´å¤šåŒ¹é…æ¡ä»¶...
    
    return True
```

## é”™è¯¯å¤„ç†

### å‰ç«¯åº”è¯¥å¤„ç†çš„æƒ…å†µ

```typescript
try {
  const result = await api.matchStatus(matchId);
  
  // âœ… æˆåŠŸï¼šstatus="matched" æˆ– status="waiting"
  if (result.success) {
    handleMatchStatus(result.data);
  }
  // âŒ å¤±è´¥ï¼šç½‘ç»œé”™è¯¯ã€æœåŠ¡å™¨é”™è¯¯ç­‰
  else {
    console.warn("æŸ¥è¯¢å¤±è´¥:", result.error);
    // ç»§ç»­è½®è¯¢ï¼Œä¸ä¸­æ–­
  }
} catch (error) {
  // ç½‘ç»œå¼‚å¸¸ï¼Œç»§ç»­è½®è¯¢
  console.error("è½®è¯¢å¼‚å¸¸:", error);
}
```

## æµç¨‹æ€»ç»“

| é˜¶æ®µ | å‰ç«¯çŠ¶æ€ | åç«¯è¡Œä¸º | ç”¨æˆ·çœ‹åˆ° |
|-----|---------|---------|---------|
| 1. é€‰æ‹©æ•…äº‹ | "generate" | - | æ•…äº‹é€‰æ‹©ç•Œé¢ |
| 2. å‘èµ·åŒ¹é… | â†’ "waiting" | åŠ å…¥é˜Ÿåˆ— | ç­‰å¾…å®¤ï¼Œå€’è®¡æ—¶å¼€å§‹ |
| 3. è½®è¯¢ä¸­... | "waiting" | æ£€æŸ¥æ˜¯å¦æœ‰é…å¯¹ | ç­‰å¾…å®¤ï¼Œæ˜¾ç¤ºå·²ç­‰å¾…æ—¶é—´ |
| 4. åŒ¹é…æˆåŠŸ | â†’ "chatting" | åˆ›å»ºèŠå¤©å®¤ | è¿›å…¥èŠå¤©å®¤ |
| 5. è¶…æ—¶æˆ–å–æ¶ˆ | â†’ "generate" | ç§»é™¤é˜Ÿåˆ— | å›åˆ°æ•…äº‹é€‰æ‹© |

## å…³é”®è¦ç‚¹

1. âœ… **åŒ¹é…è¯·æ±‚ç«‹å³è¿”å›** - ä¸è¦è®©ç”¨æˆ·ç­‰å¾…æœåŠ¡å™¨å›åº”
2. âœ… **çŠ¶æ€è½®è¯¢** - å‰ç«¯æ¯2ç§’æŸ¥è¯¢ä¸€æ¬¡çŠ¶æ€å˜åŒ–
3. âœ… **"ç­‰å¾…"æ˜¯æ­£å¸¸çŠ¶æ€** - ä¸æ˜¯é”™è¯¯ï¼Œæ˜¯é…å¯¹è¿‡ç¨‹ä¸­çš„ä¸€éƒ¨åˆ†
4. âœ… **å¯ä»¥å–æ¶ˆåŒ¹é…** - ç”¨æˆ·å¯éšæ—¶è¿”å›é‡æ–°é€‰æ‹©
5. âœ… **è¶…æ—¶ä¿æŠ¤** - 10åˆ†é’Ÿåæç¤ºè¶…æ—¶ï¼Œé¿å…æ— é™ç­‰å¾…
6. âœ… **ç»§ç»­è½®è¯¢è€Œä¸æŠ¥é”™** - å³ä½¿APIå¶å°”å¤±è´¥ï¼Œä¹Ÿåº”ç»§ç»­å°è¯•

---

**ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¶é—´**: 2026-01-19
